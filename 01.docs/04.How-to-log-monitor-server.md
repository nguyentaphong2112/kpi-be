# 1. Thực hiện tạo file bash script 

        cat > /u01/app/hrm/bash-script/monitor-system.sh

Nội dung của file như sau, lưu ý thay đổi các tham số cho từng server
```bash
        #!/bin/bash
        # Đặt thư mục lưu file log
        LOG_DIR="/u01/app/hrm/logs/system_usage"
        # Tạo thư mục nếu chưa tồn tại
        mkdir -p "$LOG_DIR"

        # Đặt tên file log theo ngày tháng
        LOG_FILE="$LOG_DIR/system_usage_$(date +"%Y-%m-%d").log"

        # Đặt thông tin đăng nhập MariaDB
        DB_USER="user database"
        DB_PASS="mật khẩu database"

        # Lấy thời gian hiện tại
        CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S")

        # Lấy thông tin mức sử dụng CPU
        CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')

        # Lấy thông tin mức sử dụng RAM
        RAM_USAGE=$(free | grep Mem | awk '{print $3/$2 * 100.0}')

        # Lấy thông tin dung lượng đĩa
        DISK_USAGE=$(df -h | awk '{if (NR > 1) printf "%s: %s, ", $1, $5}' | sed 's/, $//')

        # Lấy số lượng session của MariaDB
        DB_SESSIONS=$(mysql -u hrplus_server -p'HrpOS%$#6546' -e "SHOW PROCESSLIST;" | wc -l)

        # Ghi thông tin vào file log
        echo "$CURRENT_TIME | cpu: $CPU_USAGE% | ram: $RAM_USAGE% | disk: $DISK_USAGE | dbsession: $DB_SESSIONS" >> "$LOG_FILE"
```

# 2. Thực hiện set quyền thực thi cho file vừa tạo
```bash
    chmod +x /u01/app/hrm/bash-script/monitor-system.sh
```
# 3. Thực hiện tạo cron tab để run file trên
```bash
    crontab -e
```
Thêm dòng sau để chạy script mỗi phút 1 lần
```bash 
    */1 * * * * /u01/app/hrm/bash-script/monitor-system.sh
``` 
# 4. Cấu hình để định kỳ xóa file log

Tạo File Cấu Hình logrotate
Tạo một file cấu hình logrotate cho log của bạn. Ví dụ:
```bash
    sudo nano /etc/logrotate.d/system_usage
```
Thêm nội dung sau vào file cấu hình:
```bash
    /u01/app/hrm/logs/system_usage/system_usage_*.log {
        daily
        rotate 30
        compress
        missingok
        notifempty
        create 0640 root root
        dateext
    }
```
Thực thi logrotate
```bash 
    sudo logrotate -f /etc/logrotate.d/system_usage
```
# 5. Kiểm tra kết quả
    
Sau khi thực hiện các bước trên, bạn có thể kiểm tra kết quả lưu log của hệ thống, bằng cách kểm tra file trong thư mục **/u01/app/hrm/logs/system_usage**

Dưới đây là ví dụ của file log đã được cấu hình thành công!
```bash
    2024-09-06 17:47:01 | cpu: 1% | ram: 1.4525% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 8
    2024-09-06 17:48:01 | cpu: 0.5% | ram: 2.40971% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:49:01 | cpu: 0.7% | ram: 2.51775% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:50:01 | cpu: 0.2% | ram: 2.51213% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 11
    2024-09-06 17:51:01 | cpu: 0.7% | ram: 2.50766% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:52:01 | cpu: 0.9% | ram: 2.50486% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:53:01 | cpu: 0.5% | ram: 2.50113% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:54:01 | cpu: 0.5% | ram: 2.50429% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:55:02 | cpu: 0.5% | ram: 2.50332% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:56:01 | cpu: 0.7% | ram: 2.5022% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:57:01 | cpu: 0.2% | ram: 2.50063% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:58:01 | cpu: 0.5% | ram: 2.4969% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 17:59:01 | cpu: 0.7% | ram: 2.4962% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 18:00:01 | cpu: 0.9% | ram: 2.49426% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 10
    2024-09-06 18:01:01 | cpu: 0.7% | ram: 2.49784% | disk: tmpfs: 1%, /dev/sda4: 1%, tmpfs: 0%, tmpfs: 0%, /dev/sda2: 2%, tmpfs: 1%, tmpfs: 1% | dbsession: 8
```


    